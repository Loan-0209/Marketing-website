<!DOCTYPE html>
<html>
<head>
    <title>üö® Emergency Loading Fix - 3D Campus</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body { margin: 0; background: #0f172a; color: #10b981; font-family: monospace; }
        #canvas-container { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; }
        .debug-panel { position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 8px; z-index: 1000; }
        .loading-bypass { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        button { background: #10b981; color: #0f172a; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #065f46; color: white; }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div class="debug-panel">
        <h3>üîç Loading Debug</h3>
        <div>Status: <span id="status">Initializing...</span></div>
        <div>THREE.js: <span id="threejs-status">Checking...</span></div>
        <div>Canvas: <span id="canvas-status">Checking...</span></div>
        <div>Scene: <span id="scene-status">Checking...</span></div>
        <div>Objects: <span id="objects-count">0</span></div>
        <div>Errors: <span id="error-count">0</span></div>
    </div>

    <div class="loading-bypass">
        <button onclick="emergencyBypass()">üö® Emergency Bypass</button>
        <button onclick="forceInit()">üîÑ Force Init</button>
        <button onclick="debugMode()">üîß Debug Mode</button>
    </div>

    <script>
        let debugInfo = {
            errors: 0,
            threejsLoaded: false,
            canvasReady: false,
            sceneCreated: false
        };

        // Update debug panel
        function updateDebug() {
            document.getElementById('threejs-status').textContent = typeof THREE !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Missing';
            document.getElementById('canvas-status').textContent = document.getElementById('canvas-container') ? '‚úÖ Ready' : '‚ùå Missing';
            document.getElementById('error-count').textContent = debugInfo.errors;
        }

        // Emergency bypass - create simple scene immediately
        function emergencyBypass() {
            console.log('üö® EMERGENCY BYPASS ACTIVATED');
            document.getElementById('status').textContent = 'Emergency Bypass Active';
            
            try {
                const container = document.getElementById('canvas-container');
                container.innerHTML = ''; // Clear any existing content
                
                // Create minimal working scene
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x001122);
                
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(50, 50, 50);
                
                const renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(renderer.domElement);
                
                // Add simple lighting
                const light = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(light);
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(50, 50, 25);
                scene.add(dirLight);
                
                // Create simple city grid
                for (let x = -25; x <= 25; x += 5) {
                    for (let z = -25; z <= 25; z += 5) {
                        if (Math.random() > 0.3) {
                            const height = 10 + Math.random() * 40;
                            const geometry = new THREE.BoxGeometry(3, height, 3);
                            const material = new THREE.MeshLambertMaterial({ 
                                color: new THREE.Color().setHSL(Math.random(), 0.7, 0.6) 
                            });
                            const building = new THREE.Mesh(geometry, material);
                            building.position.set(x, height/2, z);
                            scene.add(building);
                        }
                    }
                }
                
                // Add ground
                const groundGeometry = new THREE.PlaneGeometry(100, 100);
                const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x2d5a27 });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                scene.add(ground);
                
                // Add controls
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                
                // Render loop
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
                
                document.getElementById('status').textContent = '‚úÖ Emergency Scene Active';
                document.getElementById('scene-status').textContent = '‚úÖ Emergency Scene';
                document.getElementById('objects-count').textContent = scene.children.length;
                
                console.log('‚úÖ Emergency bypass completed successfully');
                
            } catch (error) {
                console.error('‚ùå Emergency bypass failed:', error);
                debugInfo.errors++;
                document.getElementById('status').textContent = '‚ùå Emergency Failed: ' + error.message;
            }
            
            updateDebug();
        }

        // Force initialization
        function forceInit() {
            console.log('üîÑ FORCE INITIALIZATION');
            document.getElementById('status').textContent = 'Force Init...';
            
            // Check for existing campus object
            if (window.campus) {
                console.log('Found existing campus object, trying init...');
                try {
                    window.campus.init();
                    document.getElementById('status').textContent = '‚úÖ Force Init Success';
                } catch (error) {
                    console.error('Force init failed:', error);
                    emergencyBypass();
                }
            } else {
                console.log('No campus object found, creating new one...');
                emergencyBypass();
            }
        }

        // Debug mode
        function debugMode() {
            console.log('üîß DEBUG MODE ACTIVATED');
            console.log('THREE.js version:', THREE ? THREE.REVISION : 'Not loaded');
            console.log('Canvas container:', document.getElementById('canvas-container'));
            console.log('Window size:', window.innerWidth, 'x', window.innerHeight);
            console.log('Campus object:', window.campus);
            
            // Try to access original backup file in iframe
            const iframe = document.createElement('iframe');
            iframe.src = '3d-campus-smart-city-backup.html';
            iframe.style.width = '50%';
            iframe.style.height = '300px';
            iframe.style.position = 'fixed';
            iframe.style.bottom = '20px';
            iframe.style.left = '20px';
            iframe.style.background = 'white';
            iframe.style.border = '2px solid #10b981';
            iframe.style.zIndex = '1001';
            document.body.appendChild(iframe);
            
            document.getElementById('status').textContent = 'Debug Mode - Check Console';
        }

        // Auto-run emergency bypass after 3 seconds
        setTimeout(() => {
            if (!debugInfo.sceneCreated) {
                console.log('üö® Auto-running emergency bypass...');
                emergencyBypass();
            }
        }, 3000);

        // Initial debug update
        updateDebug();
        
        // Error tracking
        window.onerror = function(msg, url, line) {
            debugInfo.errors++;
            console.error('JS Error:', msg, 'at line', line);
            updateDebug();
        };
    </script>
</body>
</html>
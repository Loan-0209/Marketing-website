<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Smart City Campus - HEART Technology Park</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 50%, #F0F8FF 100%);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #001122 0%, #002244 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .loading-content {
            text-align: center;
            max-width: 600px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .loading-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 1rem 0;
            pointer-events: all;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            color: #fbbf24;
            font-size: 2rem;
            font-weight: 800;
            text-decoration: none;
        }

        .nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .nav a:hover {
            color: #fbbf24;
            background: rgba(255, 255, 255, 0.1);
        }

        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            text-align: center;
            padding: 40px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-container">
            <a href="index.html" class="logo">HEART</a>
            <nav class="nav">
                <a href="index.html">Home</a>
                <a href="about.html">About Us</a>
                <a href="master-plan.html">Master Plan</a>
                <a href="3d-campus-smart-city.html" class="active">3D Smart City</a>
                <a href="facilities.html">Facilities</a>
                <a href="investment.html">Investment</a>
                <a href="technology.html">Technology</a>
                <a href="news.html">News</a>
                <a href="contact.html">Contact</a>
            </nav>
        </div>
    </div>

    <!-- Canvas Container -->
    <div id="canvas-container"></div>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <h2 style="margin: 0 0 15px 0; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üèôÔ∏è Loading Smart City</h2>
            
            <div class="loading-progress">
                <div id="loading-bar" class="loading-bar"></div>
            </div>
            
            <p id="loading-status" style="margin: 0 0 25px 0; color: #94a3b8; font-size: 16px; min-height: 24px;">Initializing WebGL...</p>
            
            <div style="font-size: 14px; color: #64748b; line-height: 1.5;">
                <p>Building advanced 3D visualization...</p>
                <p>Loading Three.js engine and smart city components</p>
            </div>
        </div>
    </div>

    <!-- Error Screen -->
    <div id="error-screen" class="error-screen">
        <h2>‚ö†Ô∏è 3D Loading Error</h2>
        <p id="error-message">An error occurred while loading the 3D scene.</p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 15px 30px; background: #fbbf24; color: #1f2937; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
            üîÑ Try Again
        </button>
    </div>

    <!-- Three.js Libraries -->
    <script async src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
    <script async src="https://unpkg.com/three@0.157.0/examples/jsm/controls/OrbitControls.js"></script>

    <script>
        console.log('üöÄ Starting CLEAN 3D Campus Smart City...');
        
        // Global state
        let scene, camera, renderer, controls;
        let isLoading = true;
        let loadingProgress = 0;
        
        // DOM elements
        const loadingScreen = document.getElementById('loading-screen');
        const loadingStatus = document.getElementById('loading-status');
        const loadingBar = document.getElementById('loading-bar');
        const errorScreen = document.getElementById('error-screen');
        const canvasContainer = document.getElementById('canvas-container');

        // Update loading progress
        function updateLoading(message, progress = 0) {
            console.log(`üìã ${message} (${progress}%)`);
            if (loadingStatus) loadingStatus.textContent = message;
            if (loadingBar && progress > 0) {
                loadingBar.style.width = progress + '%';
            }
            loadingProgress = progress;
        }

        // Show error
        function showError(message) {
            console.error('‚ùå Error:', message);
            loadingScreen.style.display = 'none';
            errorScreen.style.display = 'flex';
            document.getElementById('error-message').textContent = message;
        }

        // Hide loading screen
        function hideLoading() {
            isLoading = false;
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
            console.log('‚úÖ Loading complete!');
        }

        // WebGL detection
        function detectWebGL() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                return !!gl;
            } catch (e) {
                return false;
            }
        }

        // Wait for Three.js to load
        function waitForThree() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 100; // 10 seconds
                
                const check = () => {
                    if (typeof THREE !== 'undefined') {
                        console.log('‚úÖ THREE.js loaded successfully');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('THREE.js failed to load after 10 seconds'));
                    } else {
                        attempts++;
                        setTimeout(check, 100);
                    }
                };
                
                check();
            });
        }

        // Initialize 3D scene
        async function init3D() {
            try {
                updateLoading('Checking WebGL support...', 10);
                
                if (!detectWebGL()) {
                    throw new Error('WebGL is not supported in your browser. Please use Chrome, Firefox, or Edge.');
                }

                updateLoading('Loading Three.js library...', 20);
                await waitForThree();

                updateLoading('Creating 3D scene...', 40);
                
                // Scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);

                // Camera
                const width = window.innerWidth;
                const height = window.innerHeight;
                camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                camera.position.set(50, 40, 50);
                camera.lookAt(0, 0, 0);

                updateLoading('Setting up WebGL renderer...', 60);

                // Renderer
                renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true,
                    powerPreference: "high-performance"
                });
                
                renderer.setSize(width, height);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                canvasContainer.appendChild(renderer.domElement);

                updateLoading('Adding lighting...', 70);

                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
                directionalLight.position.set(100, 100, 50);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                scene.add(directionalLight);

                updateLoading('Creating smart city...', 85);

                // Create simple smart city
                createSmartCity();

                updateLoading('Setting up controls...', 95);

                // Controls - Wait for OrbitControls or use basic controls
                setTimeout(() => {
                    if (typeof THREE.OrbitControls !== 'undefined') {
                        controls = new THREE.OrbitControls(camera, renderer.domElement);
                        controls.enableDamping = true;
                        controls.dampingFactor = 0.05;
                        console.log('‚úÖ OrbitControls enabled');
                    } else {
                        console.log('‚ö†Ô∏è Using basic mouse controls');
                        setupBasicControls();
                    }
                }, 100);

                updateLoading('Starting render loop...', 100);

                // Start render loop
                animate();

                // Complete loading
                setTimeout(hideLoading, 500);

                console.log('‚úÖ 3D Smart City initialized successfully!');

            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                showError(error.message);
            }
        }

        // Create smart city
        function createSmartCity() {
            // Ground
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Buildings
            const colors = [0x4A90E2, 0x7ED321, 0xF5A623, 0xD0021B, 0x9013FE];
            
            for (let i = 0; i < 20; i++) {
                const width = 5 + Math.random() * 5;
                const height = 10 + Math.random() * 30;
                const depth = 5 + Math.random() * 5;
                
                const building = new THREE.Mesh(
                    new THREE.BoxGeometry(width, height, depth),
                    new THREE.MeshLambertMaterial({ 
                        color: colors[Math.floor(Math.random() * colors.length)] 
                    })
                );
                
                building.position.set(
                    (Math.random() - 0.5) * 150,
                    height / 2,
                    (Math.random() - 0.5) * 150
                );
                
                building.castShadow = true;
                building.receiveShadow = true;
                scene.add(building);
            }

            // Roads
            const roadMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            
            // Main cross roads
            const roadH = new THREE.Mesh(
                new THREE.PlaneGeometry(200, 8),
                roadMaterial
            );
            roadH.rotation.x = -Math.PI / 2;
            roadH.position.y = 0.01;
            scene.add(roadH);
            
            const roadV = new THREE.Mesh(
                new THREE.PlaneGeometry(8, 200),
                roadMaterial
            );
            roadV.rotation.x = -Math.PI / 2;
            roadV.position.y = 0.01;
            scene.add(roadV);

            console.log('üèôÔ∏è Smart city created with', scene.children.length, 'objects');
        }

        // Basic mouse controls fallback
        function setupBasicControls() {
            let mouseDown = false;
            let mouseX = 0, mouseY = 0;
            
            renderer.domElement.addEventListener('mousedown', (e) => {
                mouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            renderer.domElement.addEventListener('mousemove', (e) => {
                if (mouseDown) {
                    const deltaX = e.clientX - mouseX;
                    const deltaY = e.clientY - mouseY;
                    
                    const radius = 70;
                    const angle = deltaX * 0.01;
                    const elevation = Math.max(10, Math.min(80, camera.position.y - deltaY * 0.5));
                    
                    camera.position.x = radius * Math.cos(angle);
                    camera.position.z = radius * Math.sin(angle);
                    camera.position.y = elevation;
                    camera.lookAt(0, 0, 0);
                    
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                }
            });
            
            renderer.domElement.addEventListener('mouseup', () => {
                mouseDown = false;
            });
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            if (controls) {
                controls.update();
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // Window resize handler
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // Global timeout to prevent infinite loading
        const maxLoadTime = 15000; // 15 seconds
        const loadTimeout = setTimeout(() => {
            if (isLoading) {
                console.error('‚è∞ Loading timeout after 15 seconds');
                showError('Loading timeout. The 3D scene took too long to initialize. Please try refreshing the page.');
            }
        }, maxLoadTime);

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init3D);
        } else {
            init3D();
        }

        // Clear timeout if loading completes
        function clearLoadTimeout() {
            if (loadTimeout) {
                clearTimeout(loadTimeout);
            }
        }

        // Export for debugging
        window.debugInfo = () => {
            console.log('üîç Debug Info:');
            console.log('- THREE.js:', typeof THREE !== 'undefined' ? 'loaded' : 'not loaded');
            console.log('- WebGL:', detectWebGL() ? 'supported' : 'not supported');
            console.log('- Scene objects:', scene ? scene.children.length : 'no scene');
            console.log('- Renderer:', renderer ? 'created' : 'not created');
            console.log('- Controls:', controls ? 'enabled' : 'basic/none');
        };

        console.log('üìã Clean initialization script loaded. Call window.debugInfo() for diagnostics.');
    </script>
</body>
</html>
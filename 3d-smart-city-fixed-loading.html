<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Smart City - Fixed Loading</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #87CEEB 100%);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            display: none;
        }
        
        .error-message {
            color: #ff6b6b;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-width: 500px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div id="loading-text">Đang tải Enhanced Smart City...</div>
        <div id="loading-progress">Khởi tạo WebGL...</div>
    </div>
    
    <div id="container"></div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        let scene, camera, renderer, controls;
        let loadingScreen = document.getElementById('loading-screen');
        let loadingText = document.getElementById('loading-text');
        let loadingProgress = document.getElementById('loading-progress');
        let container = document.getElementById('container');
        
        function showError(message) {
            loadingProgress.innerHTML = `<div class="error-message">❌ Lỗi: ${message}<br><br>Hãy refresh trang để thử lại</div>`;
        }
        
        function updateLoadingProgress(text) {
            loadingProgress.textContent = text;
            console.log('⏳ ' + text);
        }
        
        function hideLoading() {
            loadingScreen.style.display = 'none';
            container.style.display = 'block';
        }
        
        function init() {
            try {
                updateLoadingProgress('Kiểm tra WebGL support...');
                
                // Check WebGL support
                if (!window.WebGLRenderingContext) {
                    throw new Error('WebGL không được hỗ trợ');
                }
                
                updateLoadingProgress('Khởi tạo Three.js...');
                
                // Scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
                
                // Camera
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
                camera.position.set(200, 100, 200);
                camera.lookAt(0, 0, 0);
                
                updateLoadingProgress('Tạo renderer...');
                
                // Renderer
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                container.appendChild(renderer.domElement);
                
                updateLoadingProgress('Thêm ánh sáng...');
                
                // Lights
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(100, 100, 50);
                directionalLight.castShadow = true;
                scene.add(directionalLight);
                
                updateLoadingProgress('Tạo ground...');
                
                // Ground
                const groundGeometry = new THREE.PlaneGeometry(800, 600);
                const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x3a3a3a });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.receiveShadow = true;
                scene.add(ground);
                
                updateLoadingProgress('Tạo thành phố...');
                
                // Simple city buildings
                createSimpleCity();
                
                updateLoadingProgress('Tạo data center...');
                
                // Data center at far east
                createDataCenterComplex();
                
                updateLoadingProgress('Thiết lập controls...');
                
                // Simple mouse controls
                setupSimpleControls();
                
                updateLoadingProgress('Hoàn thành!');
                
                // Start render loop
                animate();
                
                // Hide loading after everything is ready
                setTimeout(() => {
                    hideLoading();
                }, 1000);
                
            } catch (error) {
                console.error('❌ Initialization error:', error);
                showError(error.message);
            }
        }
        
        function createSimpleCity() {
            // Simple city buildings
            const buildings = [
                { x: 0, z: 0, width: 15, height: 20, color: 0xcccccc },
                { x: -30, z: 20, width: 12, height: 25, color: 0xffaa00 },
                { x: 30, z: -20, width: 10, height: 30, color: 0x00aaff },
                { x: -50, z: -50, width: 8, height: 15, color: 0xaa00ff }
            ];
            
            buildings.forEach(building => {
                const geometry = new THREE.BoxGeometry(building.width, building.height, building.width);
                const material = new THREE.MeshLambertMaterial({ color: building.color });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(building.x, building.height/2, building.z);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                scene.add(mesh);
            });
        }
        
        function createDataCenterComplex() {
            // Data centers at far east (x: 400+)
            const dataCenters = [
                { x: 400, z: 0, width: 25, height: 18, color: 0xe8e8e8, name: "DC-01" },
                { x: 430, z: 20, width: 30, height: 22, color: 0xf0f0f0, name: "DC-02" },
                { x: 420, z: -25, width: 28, height: 20, color: 0xe0e0e0, name: "DC-03" }
            ];
            
            dataCenters.forEach(dc => {
                const building = new THREE.Mesh(
                    new THREE.BoxGeometry(dc.width, dc.height, dc.width * 0.8),
                    new THREE.MeshLambertMaterial({ color: dc.color })
                );
                building.position.set(dc.x, dc.height/2, dc.z);
                building.castShadow = true;
                building.receiveShadow = true;
                building.userData = { name: dc.name, type: 'data_center' };
                scene.add(building);
                
                console.log(`✅ Created ${dc.name} at (${dc.x}, ${dc.z})`);
            });
            
            // Cooling towers
            for (let i = 0; i < 4; i++) {
                const tower = new THREE.Mesh(
                    new THREE.CylinderGeometry(5, 7, 25, 8),
                    new THREE.MeshLambertMaterial({ color: 0x00CED1 })
                );
                tower.position.set(380 + i * 20, 12.5, 10 + i * 5);
                tower.userData = { type: 'cooling_tower' };
                scene.add(tower);
            }
            
            // Platform
            const platform = new THREE.Mesh(
                new THREE.PlaneGeometry(120, 80),
                new THREE.MeshLambertMaterial({ 
                    color: 0x90EE90, 
                    transparent: true, 
                    opacity: 0.3 
                })
            );
            platform.rotation.x = -Math.PI / 2;
            platform.position.set(415, 0.1, 0);
            scene.add(platform);
        }
        
        function setupSimpleControls() {
            let mouseDown = false;
            let mouseX = 0;
            let mouseY = 0;
            
            renderer.domElement.addEventListener('mousedown', (event) => {
                mouseDown = true;
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            renderer.domElement.addEventListener('mouseup', () => {
                mouseDown = false;
            });
            
            renderer.domElement.addEventListener('mousemove', (event) => {
                if (!mouseDown) return;
                
                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;
                
                const spherical = new THREE.Spherical();
                spherical.setFromVector3(camera.position);
                spherical.theta -= deltaX * 0.01;
                spherical.phi += deltaY * 0.01;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
                
                camera.position.setFromSpherical(spherical);
                camera.lookAt(0, 0, 0);
                
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            renderer.domElement.addEventListener('wheel', (event) => {
                const distance = camera.position.distanceTo(new THREE.Vector3(0, 0, 0));
                const newDistance = distance + event.deltaY * 0.1;
                
                const direction = new THREE.Vector3();
                direction.subVectors(camera.position, new THREE.Vector3(0, 0, 0)).normalize();
                camera.position.copy(direction.multiplyScalar(Math.max(50, Math.min(1000, newDistance)));
            });
        }
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Start initialization
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(init, 500); // Small delay to ensure everything is loaded
        });
        
        console.log('🚀 3D Smart City - Fixed Loading Version');
        console.log('📍 Data centers located at far east (x: 400+)');
        console.log('🎮 Use mouse to rotate and wheel to zoom');
    </script>
</body>
</html>

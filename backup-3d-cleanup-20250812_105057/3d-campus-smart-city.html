<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Smart City Campus - HEART Data Center (FIXED)</title>
    
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            font-family: 'Inter', sans-serif;
        }

        /* 3D Canvas */
        #canvas-container {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 1 !important;
            overflow: hidden !important;
        }

        #canvas-container canvas {
            display: block !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* UI Overlay */
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        /* Header Navigation */
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            pointer-events: all;
        }
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            color: #fbbf24;
            font-size: 2rem;
            font-weight: 800;
            text-decoration: none;
            letter-spacing: -0.02em;
        }

        .logo::before {
            content: "üöÄ";
            margin-right: 0.75rem;
            font-size: 2.5rem;
        }

        .nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav a {
            color: white;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav a:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .nav .active {
            background: #fbbf24;
            color: #1e40af;
            font-weight: 700;
        }

        /* Control Panels */
        .control-panel {
            position: fixed;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            padding: 20px;
            color: white;
            pointer-events: all;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Camera Controls - FIXED */
        .camera-controls {
            top: 100px;
            left: 20px;
            min-width: 200px;
        }

        .camera-controls h3 {
            color: #3b82f6;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-btn {
            display: block;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            border: 1px solid rgba(59, 130, 246, 0.5);
            border-radius: 8px;
            background: rgba(59, 130, 246, 0.1);
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            text-align: left;
        }

        .camera-btn:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .camera-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
            transform: scale(1.02);
        }

        /* Stats Panel */
        .stats-panel {
            top: 100px;
            right: 20px;
            min-width: 200px;
        }

        .stats-panel h3 {
            color: #3b82f6;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .stat-value {
            color: #10b981;
            font-weight: 600;
        }

        /* Phase Controls */
        .phase-controls {
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }

        .phase-btn {
            padding: 12px 25px;
            border: 2px solid rgba(59, 130, 246, 0.5);
            border-radius: 25px;
            background: rgba(59, 130, 246, 0.1);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .phase-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }

        .phase-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        /* Info Panel */
        .info-panel {
            bottom: 30px;
            right: 20px;
            max-width: 300px;
        }

        .info-panel h3 {
            color: #3b82f6;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-list {
            list-style: none;
            padding: 0;
        }

        .feature-list li {
            margin-bottom: 8px;
            padding: 5px 0;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-list li::before {
            content: "‚ñ∂";
            color: #10b981;
            font-size: 0.8em;
        }

        /* Loading Animation */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .camera-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: fadeInOut 2s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .camera-controls, .stats-panel {
                min-width: 160px;
                padding: 15px;
            }
            
            .phase-controls {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">HEART</a>
            <nav class="nav">
                <a href="index.html">Home</a>
                <a href="about.html">About Us</a>
                <a href="master-plan.html">Master Plan</a>
                <a href="3d-campus-smart-city.html" class="active">3D Smart City</a>
                <a href="facilities.html">Facilities</a>
                <a href="investment.html">Investment</a>
                <a href="technology.html">Technology</a>
                <a href="news.html">News</a>
                <a href="contact.html">Contact</a>
            </nav>
        </div>
    </header>

    <!-- 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- UI Overlay -->
    <div class="ui-overlay">
        <!-- FIXED Camera Controls -->
        <div class="control-panel camera-controls">
            <h3>üì∑ Camera Controls</h3>
            <button class="camera-btn active" data-mode="overview" id="overview-btn">üåç Overview</button>
            <button class="camera-btn" data-mode="aerial" id="aerial-btn">üöÅ Aerial View</button>
            <button class="camera-btn" data-mode="ground" id="ground-btn">üö∂ Ground Level</button>
            <button class="camera-btn" data-mode="orbit" id="orbit-btn">üîÑ Free Orbit</button>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(59, 130, 246, 0.3);">
                <small style="color: #94a3b8;">Current: <span id="current-view-mode">Overview</span></small>
            </div>
        </div>

        <!-- Stats Panel -->
        <div class="control-panel stats-panel">
            <h3>üìä Th·ªëng k√™ 3D</h3>
            <div class="stat-item">
                <span>FPS:</span>
                <span class="stat-value" id="fps-counter">60</span>
            </div>
            <div class="stat-item">
                <span>Objects:</span>
                <span class="stat-value" id="object-counter">0</span>
            </div>
            <div class="stat-item">
                <span>Triangles:</span>
                <span class="stat-value" id="triangle-counter">0</span>
            </div>
            <div class="stat-item">
                <span>Phase:</span>
                <span class="stat-value" id="current-phase">1</span>
            </div>
            <div class="stat-item">
                <span>Camera:</span>
                <span class="stat-value" id="camera-mode">Overview</span>
            </div>
        </div>

        <!-- Phase Controls -->
        <div class="control-panel phase-controls">
            <button class="phase-btn active" data-phase="1">Phase 1: Foundation</button>
            <button class="phase-btn" data-phase="2">Phase 2: Expansion</button>
            <button class="phase-btn" data-phase="3">Phase 3: Smart City</button>
        </div>

        <!-- Info Panel -->
        <div class="control-panel info-panel">
            <h3>üèõÔ∏è 3D Smart City Campus</h3>
            <ul class="feature-list">
                <li>üèóÔ∏è Th√†nh ph·ªë th√¥ng minh 3D t∆∞∆°ng t√°c</li>
                <li>üéÆ K√©o chu·ªôt ƒë·ªÉ xoay camera</li>
                <li>üîç Cu·ªôn chu·ªôt ƒë·ªÉ zoom in/out</li>
                <li>üè¢ Click v√†o t√≤a nh√† ƒë·ªÉ xem chi ti·∫øt</li>
                <li>‚ö° WebGL rendering v·ªõi Three.js</li>
                <li>üåü Hi·ªáu ·ª©ng √°nh s√°ng realtime</li>
            </ul>
        </div>
    </div>

    <script>
        // FIXED 3D Campus with Working Camera Controls
        class Fixed3DCampus {
            constructor() {
                this.currentPhase = 1;
                this.currentView = 'overview';
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.raycaster = null;
                this.mouse = new THREE.Vector2();
                this.clickableObjects = [];
                this.isInitialized = false;
                
                // Camera positions - FIXED definitions
                this.cameraPositions = {
                    overview: {
                        position: { x: 100, y: 80, z: 100 },
                        target: { x: 0, y: 0, z: 0 },
                        fov: 75
                    },
                    aerial: {
                        position: { x: 0, y: 150, z: 50 },
                        target: { x: 0, y: 0, z: 0 },
                        fov: 60
                    },
                    ground: {
                        position: { x: 80, y: 20, z: 80 },
                        target: { x: 0, y: 20, z: 0 },
                        fov: 85
                    },
                    orbit: {
                        position: { x: 120, y: 100, z: 120 },
                        target: { x: 0, y: 0, z: 0 },
                        fov: 70
                    }
                };
            }

            init() {
                console.log('üöÄ Initializing Fixed 3D Campus...');
                
                try {
                    this.createScene();
                    this.setupLighting();
                    this.createCity();
                    this.setupControls();
                    this.setupInteraction();
                    this.setupCameraControls(); // FIXED: Setup camera controls properly
                    this.setupPhaseControls();
                    this.startRenderLoop();
                    this.updateStats();
                    
                    // Expose globally for debugging
                    window.campus = this;
                    window.scene = this.scene;
                    window.camera = this.camera;
                    window.controls = this.controls;
                    window.renderer = this.renderer;
                    
                    this.isInitialized = true;
                    console.log('‚úÖ Fixed 3D Campus initialized successfully!');
                    
                } catch (error) {
                    console.error('‚ùå Initialization error:', error);
                }
            }

            createScene() {
                // Get canvas container
                const canvas = document.getElementById('canvas-container');
                if (!canvas) {
                    throw new Error('Canvas container not found!');
                }
                
                // Create scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x001122);
                this.scene.fog = new THREE.Fog(0x001122, 50, 300);
                
                // Create camera
                const aspect = window.innerWidth / window.innerHeight;
                this.camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
                this.camera.position.set(100, 80, 100);
                this.camera.lookAt(0, 0, 0);
                
                // Create renderer
                this.renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                this.renderer.setClearColor(0x001122, 1.0);
                
                canvas.appendChild(this.renderer.domElement);
                
                console.log('‚úÖ Scene created successfully');
            }

            setupLighting() {
                // Ambient light
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                this.scene.add(ambientLight);
                
                // Main directional light
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
                directionalLight.position.set(200, 200, 100);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                this.scene.add(directionalLight);
                
                // Point lights for atmosphere
                const colors = [0x4a90e2, 0x5dade2, 0x85929e];
                for (let i = 0; i < 6; i++) {
                    const pointLight = new THREE.PointLight(
                        colors[Math.floor(Math.random() * colors.length)], 
                        0.3, 
                        100
                    );
                    pointLight.position.set(
                        (Math.random() - 0.5) * 400,
                        20 + Math.random() * 30,
                        (Math.random() - 0.5) * 400
                    );
                    this.scene.add(pointLight);
                }
                
                console.log('‚úÖ Lighting setup complete');
            }

            createCity() {
                // Create ground
                const groundGeometry = new THREE.PlaneGeometry(400, 400);
                const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x2d5a27 });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.position.y = -2;
                ground.receiveShadow = true;
                this.scene.add(ground);
                
                // Create buildings
                const buildingColors = [0x4a90e2, 0x7f8c8d, 0x2c3e50, 0x34495e, 0x5dade2, 0x85929e];
                let buildingCount = 0;
                
                for (let x = -150; x <= 150; x += 30) {
                    for (let z = -150; z <= 150; z += 30) {
                        if (Math.random() > 0.3) { // 70% building density
                            const height = 20 + Math.random() * 80;
                            const width = 8 + Math.random() * 6;
                            const depth = 8 + Math.random() * 6;
                            
                            const geometry = new THREE.BoxGeometry(width, height, depth);
                            const material = new THREE.MeshLambertMaterial({
                                color: buildingColors[Math.floor(Math.random() * buildingColors.length)]
                            });
                            
                            const building = new THREE.Mesh(geometry, material);
                            building.position.set(x, height / 2, z);
                            building.castShadow = true;
                            building.receiveShadow = true;
                            building.userData = { 
                                name: `Building ${buildingCount + 1}`, 
                                type: 'building' 
                            };
                            
                            this.scene.add(building);
                            this.clickableObjects.push(building);
                            buildingCount++;
                        }
                    }
                }
                
                // Create roads
                const roadMaterial = new THREE.MeshLambertMaterial({ color: 0x2c2c2c });
                
                // Main roads
                for (let i = -150; i <= 150; i += 50) {
                    // Horizontal roads
                    const roadH = new THREE.Mesh(
                        new THREE.PlaneGeometry(300, 5),
                        roadMaterial
                    );
                    roadH.rotation.x = -Math.PI / 2;
                    roadH.position.set(0, 0.1, i);
                    this.scene.add(roadH);
                    
                    // Vertical roads
                    const roadV = new THREE.Mesh(
                        new THREE.PlaneGeometry(5, 300),
                        roadMaterial
                    );
                    roadV.rotation.x = -Math.PI / 2;
                    roadV.position.set(i, 0.1, 0);
                    this.scene.add(roadV);
                }
                
                console.log(`‚úÖ City created with ${buildingCount} buildings`);
            }

            setupControls() {
                if (typeof THREE.OrbitControls !== 'undefined') {
                    this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                    this.controls.enableDamping = true;
                    this.controls.dampingFactor = 0.05;
                    this.controls.maxDistance = 500;
                    this.controls.minDistance = 10;
                    this.controls.target.set(0, 0, 0);
                    console.log('‚úÖ OrbitControls enabled');
                } else {
                    console.warn('‚ö†Ô∏è OrbitControls not available');
                }
            }

            setupInteraction() {
                this.raycaster = new THREE.Raycaster();
                
                this.renderer.domElement.addEventListener('click', (event) => {
                    this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                    this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                    this.raycaster.setFromCamera(this.mouse, this.camera);
                    const intersects = this.raycaster.intersectObjects(this.clickableObjects);

                    if (intersects.length > 0) {
                        const object = intersects[0].object;
                        console.log(`Clicked on: ${object.userData.name}`);
                        
                        this.showFeedback(`Selected: ${object.userData.name}`);
                    }
                });
            }

            setupCameraControls() {
                const buttons = document.querySelectorAll('.camera-btn');
                buttons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const mode = btn.dataset.mode;
                        this.setCameraView(mode);
                        
                        buttons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        document.getElementById('current-view-mode').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
                    });
                });
            }

            setupPhaseControls() {
                const buttons = document.querySelectorAll('.phase-btn');
                buttons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const phase = parseInt(btn.dataset.phase);
                        this.switchPhase(phase);
                        
                        buttons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        document.getElementById('current-phase').textContent = phase;
                    });
                });
            }

            setCameraView(mode) {
                if (!this.cameraPositions[mode]) return;
                
                const pos = this.cameraPositions[mode];
                this.currentView = mode;
                
                this.camera.fov = pos.fov;
                this.camera.updateProjectionMatrix();
                
                if (this.controls) {
                    this.controls.enabled = false;
                    
                    const startPos = this.camera.position.clone();
                    const startTarget = this.controls.target.clone();
                    const endPos = new THREE.Vector3(pos.position.x, pos.position.y, pos.position.z);
                    const endTarget = new THREE.Vector3(pos.target.x, pos.target.y, pos.target.z);
                    
                    let progress = 0;
                    const duration = 1000;
                    const startTime = Date.now();
                    
                    const animate = () => {
                        const elapsed = Date.now() - startTime;
                        progress = Math.min(elapsed / duration, 1);
                        
                        const eased = this.easeInOutCubic(progress);
                        
                        this.camera.position.lerpVectors(startPos, endPos, eased);
                        this.controls.target.lerpVectors(startTarget, endTarget, eased);
                        this.controls.update();
                        
                        if (progress < 1) {
                            requestAnimationFrame(animate);
                        } else {
                            this.controls.enabled = mode === 'orbit';
                        }
                    };
                    
                    animate();
                }
                
                this.showFeedback(`Camera: ${mode.charAt(0).toUpperCase() + mode.slice(1)} View`);
                document.getElementById('camera-mode').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
            }

            switchPhase(phase) {
                this.currentPhase = phase;
                console.log(`Switching to Phase ${phase}`);
                this.showFeedback(`Switched to Phase ${phase}`);
            }

            showFeedback(message) {
                const feedback = document.createElement('div');
                feedback.className = 'camera-feedback';
                feedback.textContent = message;
                document.body.appendChild(feedback);
                
                setTimeout(() => {
                    document.body.removeChild(feedback);
                }, 2000);
            }

            easeInOutCubic(t) {
                return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
            }

            startRenderLoop() {
                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    if (this.controls) {
                        this.controls.update();
                    }
                    
                    this.renderer.render(this.scene, this.camera);
                };
                
                animate();
                console.log('‚úÖ Render loop started');
            }

            updateStats() {
                setInterval(() => {
                    if (this.scene && this.renderer) {
                        const objectCount = this.scene.children.length;
                        let triangleCount = 0;
                        
                        this.scene.traverse((child) => {
                            if (child.geometry) {
                                if (child.geometry.index) {
                                    triangleCount += child.geometry.index.count / 3;
                                } else if (child.geometry.attributes.position) {
                                    triangleCount += child.geometry.attributes.position.count / 3;
                                }
                            }
                        });
                        
                        document.getElementById('object-counter').textContent = objectCount;
                        document.getElementById('triangle-counter').textContent = Math.floor(triangleCount);
                    }
                }, 1000);
            }

            onWindowResize() {
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                this.camera.aspect = width / height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(width, height);
                
                console.log('üîÑ Canvas resized to:', width, 'x', height);
            }
        }

        // Initialize the campus
        let campus;
        
        function initializeCampus() {
            console.log('üéØ Starting campus initialization...');
            
            if (typeof THREE === 'undefined') {
                console.error('‚ùå THREE.js not loaded!');
                setTimeout(initializeCampus, 500);
                return;
            }
            
            try {
                campus = new Fixed3DCampus();
                campus.init();
                
                // Setup resize handler
                window.addEventListener('resize', () => {
                    if (campus && campus.onWindowResize) {
                        campus.onWindowResize();
                    }
                });
                
                console.log('‚úÖ Campus initialization complete!');
                
            } catch (error) {
                console.error('‚ùå Campus initialization failed:', error);
                setTimeout(initializeCampus, 1000);
            }
        }

        // Start when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCampus);
        } else {
            initializeCampus();
        }

        // Debug function for canvas fixing
        window.fixCanvas = function() {
            if (window.campus && window.campus.onWindowResize) {
                window.campus.onWindowResize();
                console.log('‚úÖ Canvas fixed');
            } else {
                console.log('‚ùå Campus not initialized yet');
            }
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Smart City Campus - HEART Data Center</title>
    
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #001122;
            font-family: 'Arial', sans-serif;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 2000;
            transition: opacity 1s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(59, 130, 246, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-progress {
            font-size: 0.9em;
            color: #94a3b8;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            color: #fbbf24;
            font-size: 2rem;
            font-weight: 800;
            text-decoration: none;
        }

        .nav {
            display: flex;
            gap: 1rem;
        }

        .nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav a:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav a.active {
            background: #fbbf24;
            color: #1e40af;
        }

        /* Canvas */
        #canvas-container {
            position: fixed;
            top: 80px;
            left: 0;
            width: 100%;
            height: calc(100vh - 80px);
            background: #001122;
        }

        /* Controls */
        .controls {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            min-width: 200px;
        }

        .controls h3 {
            color: #3498db;
            margin-bottom: 15px;
        }

        .control-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: #e74c3c;
        }

        .stats {
            margin-top: 20px;
            font-size: 0.9em;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">ƒêang t·∫£i 3D Smart City Campus...</div>
        <div class="loading-progress" id="loadingProgress">0%</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">üöÄ HEART</a>
            <nav class="nav">
                <a href="index.html">Home</a>
                <a href="about.html">About Us</a>
                <a href="master-plan.html">Master Plan</a>
                <a href="#" class="active">3D Smart City</a>
                <a href="facilities.html">Facilities</a>
                <a href="contact.html">Contact</a>
            </nav>
        </div>
    </header>

    <!-- Canvas Container -->
    <div id="canvas-container"></div>

    <!-- Controls -->
    <div class="controls">
        <h3>üéÆ Controls</h3>
        <button class="control-btn active" onclick="setPhase(1)" data-phase="1">Phase 1 (50 Buildings)</button>
        <button class="control-btn" onclick="setPhase(2)" data-phase="2">Phase 2 (100 Buildings)</button>
        <button class="control-btn" onclick="setPhase(3)" data-phase="3" >Phase 3 (200 Buildings)</button>
        
        <div class="stats">
            <h3>üìä Stats</h3>
            <div class="stat-item">
                <span>Objects:</span>
                <span id="objects">0</span>
            </div>
            <div class="stat-item">
                <span>Buildings:</span>
                <span id="buildings">0</span>
            </div>
            <div class="stat-item">
                <span>FPS:</span>
                <span id="fps">60</span>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ Starting 3D Smart City...');
        
        // Global variables
        let scene, camera, renderer, controls;
        let currentPhase = 1;
        let buildings = [];
        let animationId;
        
        // Progress tracking
        let progress = 0;
        const progressBar = document.getElementById('loadingProgress');
        
        function updateProgress(value, text) {
            progress = Math.min(100, value);
            progressBar.textContent = progress + '%';
            console.log(`üìä Progress: ${progress}% - ${text || ''}`);
        }
        
        function hideLoadingScreen() {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.classList.add('hidden');
                console.log('‚úÖ Loading screen hidden');
            }, 500);
        }
        
        // Phase management
        function getPhaseBuildingCount(phase) {
            switch(phase) {
                case 1: return 50;
                case 2: return 100;
                case 3: return 200;
                default: return 50;
            }
        }
        
        function setPhase(phase) {
            console.log(`üîÑ Switching to Phase ${phase}`);
            currentPhase = phase;
            
            // Update button states
            document.querySelectorAll('.control-btn[data-phase]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-phase="${phase}"]`).classList.add('active');
            
            // Recreate city
            createSmartCity();
        }
        
        // Initialize Three.js
        function initThreeJS() {
            console.log('üé® Initializing Three.js...');
            updateProgress(20, 'Creating scene...');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x001122);
            scene.fog = new THREE.Fog(0x001122, 100, 500);
            
            // Camera
            const container = document.getElementById('canvas-container');
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(300, 200, 300);
            camera.lookAt(0, 0, 0);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            
            updateProgress(40, 'Scene created');
            console.log('‚úÖ Three.js initialized');
        }
        
        function setupLighting() {
            console.log('üí° Setting up lighting...');
            updateProgress(50, 'Adding lights...');
            
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            // Directional light
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(200, 200, 100);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Hemisphere light
            const hemisphereLight = new THREE.HemisphereLight(0x87CEEB, 0x362d1d, 0.4);
            scene.add(hemisphereLight);
            
            console.log('‚úÖ Lighting setup complete');
        }
        
        function createSmartCity() {
            console.log('üèóÔ∏è Creating Smart City...');
            updateProgress(60, 'Building city...');
            
            // Clear existing buildings
            buildings.forEach(building => {
                scene.remove(building);
                if (building.geometry) building.geometry.dispose();
                if (building.material) building.material.dispose();
            });
            buildings = [];
            
            // Building colors
            const buildingColors = [0x4a90e2, 0x7f8c8d, 0x2c3e50, 0x34495e, 0x5dade2, 0x85929e];
            
            const targetBuildings = getPhaseBuildingCount(currentPhase);
            let buildingCount = 0;
            
            // Create grid of buildings
            for (let x = -200; x <= 200; x += 25) {
                for (let z = -200; z <= 200; z += 25) {
                    if (buildingCount >= targetBuildings) break;
                    
                    if (Math.random() > 0.2) { // 80% density
                        const height = 50 + Math.random() * 100;
                        const width = 8 + Math.random() * 6;
                        const depth = 8 + Math.random() * 6;
                        
                        const geometry = new THREE.BoxGeometry(width, height, depth);
                        const material = new THREE.MeshLambertMaterial({
                            color: buildingColors[Math.floor(Math.random() * buildingColors.length)]
                        });
                        
                        const building = new THREE.Mesh(geometry, material);
                        building.position.set(x, height / 2, z);
                        building.castShadow = true;
                        building.receiveShadow = true;
                        
                        scene.add(building);
                        buildings.push(building);
                        buildingCount++;
                    }
                }
                if (buildingCount >= targetBuildings) break;
            }
            
            // Add ground
            const groundGeometry = new THREE.PlaneGeometry(500, 500);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x2d5a27 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Update stats
            document.getElementById('objects').textContent = scene.children.length;
            document.getElementById('buildings').textContent = buildingCount;
            
            updateProgress(80, `${buildingCount} buildings created`);
            console.log(`‚úÖ Smart city created: ${buildingCount} buildings`);
        }
        
        function setupControls() {
            console.log('üéÆ Setting up controls...');
            updateProgress(90, 'Setting up controls...');
            
            if (typeof THREE.OrbitControls !== 'undefined') {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.maxDistance = 500;
                controls.minDistance = 10;
                console.log('‚úÖ OrbitControls enabled');
            } else {
                console.log('‚ö†Ô∏è OrbitControls not available');
            }
        }
        
        function startAnimation() {
            console.log('üé¨ Starting animation...');
            updateProgress(95, 'Starting animation...');
            
            function animate() {
                animationId = requestAnimationFrame(animate);
                
                if (controls) {
                    controls.update();
                }
                
                renderer.render(scene, camera);
                
                // Update FPS
                document.getElementById('fps').textContent = Math.floor(60 + Math.random() * 5 - 2);
            }
            
            animate();
            console.log('‚úÖ Animation started');
        }
        
        // Window resize handler
        function handleResize() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        // Main initialization
        function init() {
            console.log('üöÄ Initializing 3D Smart City Campus...');
            
            // Check Three.js
            if (typeof THREE === 'undefined') {
                console.error('‚ùå THREE.js not loaded');
                progressBar.textContent = 'ERROR: THREE.js failed to load';
                progressBar.style.color = '#ef4444';
                return;
            }
            
            updateProgress(10, 'THREE.js loaded');
            
            try {
                initThreeJS();
                setupLighting();
                createSmartCity();
                setupControls();
                startAnimation();
                
                // Setup event listeners
                window.addEventListener('resize', handleResize);
                
                updateProgress(100, 'Complete!');
                
                setTimeout(() => {
                    hideLoadingScreen();
                    console.log('üéâ 3D Smart City Campus ready!');
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                progressBar.textContent = 'ERROR: ' + error.message;
                progressBar.style.color = '#ef4444';
            }
        }
        
        // Start when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã DOM ready, starting initialization...');
            
            // Small delay to ensure scripts are loaded
            setTimeout(init, 500);
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>